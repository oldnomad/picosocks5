image: debian:stable-slim

stages:
  - build
  - release

.build-common:
  before_script: &build_common_script
    - apt-get update -qq
    - apt-get install -y -qq build-essential autoconf automake debhelper pandoc pkg-config libgnutls-dev libssl-dev
    - autoconf --version
    - automake --version
    - gcc --version
    - pkg-config --modversion libgnutls
    - pkg-config --modversion libssl

test-build:
  stage: build
  before_script: *build_common_script
  script:
    - autoreconf -f -i -Wall
    - ./configure
    - make
    - ./configure --without-gnutls
    - make
    - ./configure --without-gnutls --without-openssl
    - make
  except:
    - tags

debian-packages:
  stage: release
  before_script: *build_common_script
  script:
    - autoreconf -f -i -Wall
    - dpkg-buildpackage -us -uc
    - mkdir build
    - mv ../picosocks5*.deb build/
    - mv ../picosocks5*.dsc build/
    - mv ../picosocks5*.changes build/
    - mv ../picosocks5*.buildinfo build/
  only:
    - tags
  artifacts:
    name: "picosocks5-$CI_COMMIT_TAG"
    paths:
      - build/*
