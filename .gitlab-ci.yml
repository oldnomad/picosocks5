image: debian:stable-slim

stages:
  - build
  - release

.build-common:
  before_script: &build_common_script
    - apt-get update -qq
    - apt-get install -y -qq build-essential autoconf automake pandoc pkg-config libssl-dev
    - autoconf --version
    - automake --version
    - gcc --version
    - pkg-config --modversion libssl

build-proj:
  stage: build
  before_script: *build_common_script
  script:
    - autoreconf -f -i -Wall
    - ./configure
    - make
  except:
    - tags

package-proj:
  stage: release
  before_script: *build_common_script
  script:
    - autoreconf -f -i -Wall
    - dpkg-buildpackage -us -uc
    - mkdir build
    - mv ../picosocks5*.deb build/
  only:
    - tags
  artifacts:
    name: "picosocks5-$CI_COMMIT_TAG"
    paths:
      - build/*
